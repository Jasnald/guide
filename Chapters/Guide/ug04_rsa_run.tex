\section{Step 4: Residual Stress Analysis (RSA)}
\label{sec:guide_rsa}

\textbf{Goal:} Map the CMA stress field onto the RSA mesh, inject \texttt{*Initial Conditions}, solve, and convert results.

\subsection{Action: Execution}

\begin{lstlisting}[language=bash]
# Experiment 1 -- run full RSA (includes CMA dependency)
python scripts/e1_simulation_run.py rsa --all

# Experiment 2
python scripts/e2_simulation_run.py rsa --all
\end{lstlisting}

\textbf{Phase flags for RSA:}
\begin{table}[ht]
\centering
\begin{tabular}{ll}
\hline
\textbf{Flag} & \textbf{Effect} \\
\hline
\texttt{--cma}  & Re-run the CMA pipeline first (ensures fresh HDF5 source data). \\
\texttt{--sim}  & Stress mapping + Abaqus job submission only. \\
\texttt{--conv} & ODB extraction + NPY-to-XDMF conversion only. \\
\texttt{--all}  & \texttt{--cma} + \texttt{--sim} + \texttt{--conv}. \\
\hline
\end{tabular}
\end{table}

If CMA results from Step~3 are already up to date, skip the CMA re-run:
\begin{lstlisting}[language=bash]
python scripts/e1_simulation_run.py rsa --sim --conv
\end{lstlisting}

\subsection{What Happens Internally}
\begin{enumerate}
    \item \texttt{ClearDirectory} purges \texttt{rea\_directory}.
    \item \texttt{GeometryGenerator} builds RSA meshes using \texttt{rsa/script.py} (Exp1) or \texttt{rsa2/script.py} (Exp2).
    \item \texttt{Nodes\_main} extracts element centroids from the RSA mesh.
    \item \texttt{StressProcessor} (Exp1) or \texttt{StressProcessorBatch} (Exp2) maps $S_{33}$ from the CMA HDF5 source onto the RSA centroids via KDTree.
    \item \texttt{ResidualProcessor} injects \texttt{*Initial Conditions, type=STRESS} into every \texttt{.inp}.
    \item \texttt{INPRunner} submits all jobs.
    \item \texttt{ResultConverter} extracts ODB data and converts to XDMF/HDF5.
\end{enumerate}

\subsection{Verification}
Check \texttt{rea\_directory}:
\begin{itemize}
    \item CSV files per case confirm that stress mapping completed successfully.
    \item \texttt{*.h5} / \texttt{*.xdmf} files confirm successful conversion.
    \item Abaqus \texttt{.odb} files are present in each job sub-directory.
\end{itemize}